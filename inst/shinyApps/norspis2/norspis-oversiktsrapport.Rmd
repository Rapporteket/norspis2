---
title: "Rapport - NorSpis"
author: 'Nasjonal oversikt'
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: 2
  html_document:
    df_print: paged
params: 
  reshID: 700821
  dateFrom: !r format(Sys.Date(), "%Y")
  dateTo: "`r Sys.Date()`" 
---

[//]: # Just a list of usefull rmarkdown formatting commands:
[//]: # \pagebreak


[//]: # just setting things up
```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo = params$reshID,
  warning=FALSE,
  comment = "#>",
  cache.path = 'F:/'
)
```

```{r loadPackages, include=FALSE}
#rm(list=ls()) WARNING: Do not use this line in parameterized .Rmd-documents, or else the parameters will not be found 
library(rapbase)
library(tidyverse)
library(norspis2)
```

[//]: # remember to load data - use "script-to-load-data-locally-norspis (...)"

```{r}
library(dplyr)
#------DATA norspis2
RegData2 <- norspis2::fun1_1_import_data_FEA(path_data="F:/2021-09-13/", #disk and folder of data to import
                                             date_data="2021-09-13")

RegDataBeh2 <- norspis2::fun1_2_import_data_B(path_data="F:/2021-09-13/", #disk and folder of data to import
                                              date_data="2021-09-13")
#Five datasets (and outputted in a list):
DL <- norspis2::fun2_dataList(myInData1 = RegData2, myInData2 = RegDataBeh2)
#---DATA norspis2 (END)
#-----DATA  for norspis functions
#When we use norspis functions we use the call "RegData" (while we in norspis2 use DL$RegData12345)
RegData <- RegData2
#---DATA norspis2 (END)
```


[//]: # paramemters 

<!-- ```{r} -->
<!-- reshID = '700821' #TESTNO" , Oslo: 109979, Bodø: 700821 -->
<!-- userRole <-'SC' #'CC' , 'LC', 'LU' -->
<!-- ``` -->

\pagebreak

# Om denne rapporten

*Bruk:* Til bruk i fagrådsmøte uke 37 2021. Annen bruk må avklares med NorSpis-administrasjonen,
og dokumenteres der.

*Datagrunnlag:* Til og med uke 36, 2021 (12. september).


\pagebreak

# Antall pasienter

* Totalt
* Over tid
* Per enhet

\pagebreak

# Antall registreringer

* Totalt
* Over tid
* Per enhet


<!-- ## Antall registreringer per enhet -->
<!-- ```{r} -->
<!-- myInData <- DL$RegData2 -->
<!-- RegDataNatVal_filtered2019 <- norspis2::fun3_1_filter_RegData(RegData = myInData, -->
<!--                                                               regStatus = c(1), -->
<!--                                                               regType = c(1,2,3,4,5,6,98,99), -->
<!--                                                               dateFrom = "2020-01-01", -->
<!--                                                               dateTo = "2021-12-31", -->
<!--                                                               ageFrom = 0, -->
<!--                                                               ageTo = 200) -->

<!-- tab <- norspis2::make_table_DQ_regCount(RegDataNatVal_filtered2019) #%>% -->
<!--           #flextable::set_table_properties(layout = "autofit") -->
<!--           #flextable::fit_to_width(7.5) -->

<!-- #ft <- norspis2::make_table_DQ_regCount_asFt(tab) -->

<!-- tab[[2]] -->

<!-- #https://stackoverflow.com/questions/57175351/flextable-autofit-in-a-rmarkdown-to-word-doc-causes-table-to-go-outside-page-mar -->
<!-- # FitFlextableToPage <- function(ft, pgwidth = 5){ -->
<!-- #  -->
<!-- #   ft_out <- ft %>% flextable::autofit() -->
<!-- #  -->
<!-- #   ft_out <- flextable::width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable::flextable_dim(ft_out)$widths)) -->
<!-- #   return(ft_out) -->
<!-- # } -->
<!-- #  -->
<!-- # FitFlextableToPage(tab[[2]]) -->

<!-- ``` -->

\pagebreak

## Antall registreringer per avdeling per år

### Startregistreringer (ferdigstilte)

```{r, resize.width=5,resize.height=6}
  #START
  #filter data for e.g. 2012-2019
  RegDataNatValFiltered <- fun3_1_filter_RegData(RegData = DL$RegDataNatVal2 ,
                                                 regStatus = c(1),
                                                 regType = c(1,2,3,4),#START
                                                 dateFrom = "2012-01-01",
                                                 dateTo = "2021-12-31",
                                                 ageFrom = 0,
                                                 ageTo = 200)

  tab_start <- norspis2::make_table_DQ_regCountYearly(RegDataNatValFiltered = RegDataNatValFiltered,
                                                      width_first_column = 1.5)
  
  tab_start[[2]]
  

```


\pagebreak

### Sluttregistreringer (ferdigstilte)

```{r}
#END
  #filter data for e.g. 2012-2019
  RegDataNatValFiltered <- fun3_1_filter_RegData(RegData = DL$RegDataNatVal2 ,
                                                 regStatus = c(1),
                                                 regType = c(5,6,98,99),#END
                                                 dateFrom = "2012-01-01",
                                                 dateTo = "2021-12-31",
                                                 ageFrom = 0,
                                                 ageTo = 200)

  tab_slutt <- norspis2::make_table_DQ_regCountYearly(RegDataNatValFiltered = RegDataNatValFiltered)
  
  tab_slutt[[2]]
  
```
\pagebreak

### Startregistreringer (inkludert uferdige)

```{r, resize.width=5,resize.height=6}
  #START
  #filter data for e.g. 2012-2019
  RegDataNatValFiltered <- fun3_1_filter_RegData(RegData = DL$RegDataNatVal2 ,
                                                 regStatus = c(-1,0,1),
                                                 regType = c(1,2,3,4),#START
                                                 dateFrom = "2012-01-01",
                                                 dateTo = "2021-12-31",
                                                 ageFrom = 0,
                                                 ageTo = 200)

  tab_start <- norspis2::make_table_DQ_regCountYearly(RegDataNatValFiltered = RegDataNatValFiltered,
                                                      width_first_column = 1.5)
  
  tab_start[[2]]
  

```


\pagebreak

### Sluttregistreringer (inkludert uferdige)

```{r}
#END
  #filter data for e.g. 2012-2019
  RegDataNatValFiltered <- fun3_1_filter_RegData(RegData = DL$RegDataNatVal2 ,
                                                 regStatus = c(-1,0,1),
                                                 regType = c(5,6,98,99),#END
                                                 dateFrom = "2012-01-01",
                                                 dateTo = "2021-12-31",
                                                 ageFrom = 0,
                                                 ageTo = 200)

  tab_slutt <- norspis2::make_table_DQ_regCountYearly(RegDataNatValFiltered = RegDataNatValFiltered)
  
  tab_slutt[[2]]
  
```

\pagebreak

# Datakvalitetsmål

* Totalt
* Over tid
* Per enhet

\pagebreak

## Forløpskompletthet

Under følger et forslag til beregning av forløpskompletthet. 

**Definsjon av forløpskomplettet**: Andelen leverte sluttregistreringer av alle 
leverte startregisteringer, for alle behandlingsforløp som faktisk er ferdige.

**Utfordring ved bergning av forløpskompletthet**: Det er vanskelig å måle 
forløpskompletthet direkte fordi man i fraværet av en sluttregistrering ikke 
vet om en sluttregistrering skulle vært levert eller om pasienten fremdeles er i
behandling og derfor enda ikke aktulle for sluttregistrering.

**Løsning**: Sannsynlighetsbasert beregning, basert på statistikk fra NorSpis om
behandlingslengdene for de komplette forløpene. Dette gir et estimat, som ikke 
vil være presist, men kan gi enhetene pekepinn. 

**Hvorfor beregne forløpskompletthet?**: Statistikken gir enhetene en mulighet til
jobbe med å forbedre sin forløpskompletthet ved å sammenligne seg med seg selv 
over tid, samt med andre enheter. Forløpskompletthet er et viktig datakvalitets-
mål fordi blant annet kvalitetsindikatorene kun kan beregnes ut fra sluttreg-
istreringene. Høy forløpskompletthet reduserer faren for skjevheter (*bias*), og
øker generaliserbarheten av enhetenes resultater tilbake til egen pasientgruppe.

\pagebreak


### Beregning - teoretisk bakgrunn (for spesielt interesserte)

Som et pedagogisk utgangspunkt kan vi kan først beregne en ræ 
forløpskompletthet, som altså ikke tar hensyn til at noen av registreringene 
jo ikke skulle

Under følger en tabell med "rå" forløpskompletthet i NorSpis for hele registerets
levetid og frem til i dag:

```{r}
completeness <- make_table_DQ_completeness_endreg()

raw_completeness <- completeness[[1]]%>%
  mutate(across(where(is.numeric), round, 1))


flextable::flextable(raw_completeness)

```


Vi beregner først behandlingslengden i NorSpis, som tiden fra start av behandling
til slutt av behandling:
```{r, echo=T}
#Treatment length, days - we make such a variable like this:
times <- as.Date(DL$RegDataStartEnd2$HovedDato.y)-
  as.Date(DL$RegDataStartEnd2$HovedDato.x)

#Quick inspection:
summary(as.numeric(times))

```

Over ser vi at median behandlingslengde i NorSpis, for komplette forløp, er 
119 dager, mens gjennomsnittet er 174 dager. Høyere gjennomsnitt enn median, 
indikerer at det er noen behandlingsforløp som er mye lengre enn hva som er 
mest normalt, og dermed drar opp gjennomsnittet. 


Basert på behandlingstidene, ønsker vi å finne sannsynligheten for at en 
behandlingstid på x antall dager skulle væ rt ferdigstil. 
Til det bruker vi en funksjon i en statistikk-pakke i R som heter *stats*:

```{r, echo=TRUE}
# To calculate the probability for a given treatment length, we first 
#utilize the ecdf function (tip on it here: https://stats.stackexchange.com/questions/209369/estimate-the-probability-of-the-distribution-of-a-sample)

time_cdf <- ecdf(times) #this becomes a function

```

Med denne funksjonen kan vi for eksempel finne sannsynligheten for at en 
andelen registreringer som er har behandlingslengde på opp til 365 dager, 
og vi kan også plotte den kumulative sannsynlighetsfordelingen for 
behandlingslengdene:

```{r, echo=TRUE}
#we can plot the cumulative distribution of probabilities of treatment lengths:
plot(ecdf(times))

##and we can use the time_cdf function to calculate probabilities:
#For instance we can get the probability for a treatment length of 365 days:
time_cdf(365)


```
Vi ser at 88,8 prosent av ferdigstilte registreringer i NorSpis har en lengde på mindre enn
365 dager. 

Under en rekke forutsetning, som ikke alltid vil holde,men likevel ikke er til 
hinder for en fornuftig analyse, kan man som et estimat si at en en registrering 
med startdato for 365 dager siden, med 88,8 prosents sannsynlghet skulle vært 
levert.

Denne tankegangen kan man videre bruke til å estimere hvor mange av startregistreringene
ved en enhet som skulle vært levert, på bakgrunn av at vi vet datoen for 
startregistreringen.

\pagebreak

For å beregne forløpskompletthet ut fra tankegangen over, er noen ytterligere 
variabler beregnet. En tabell med disse variablene og esitimert forløpskompletthet
per avdeling i NorSpis følger under:

```{r, echo=TRUE}
#we have made a function to that computes and presents the needed variables:
completeness <- norspis2::make_table_DQ_completeness_endreg()

estimated_completeness <- completeness[[2]]

flextable::flextable(estimated_completeness)
```

Til å vurdere metoden vi har brukt for å estimere forløpskomplettheten, kan 
vi også se på forskjellen mellom den rå kompletthet og estimert kompletthet:
```{r}
completeness <- norspis2::make_table_DQ_completeness_endreg()

difference_raw_estimated_completeness <- completeness[[3]]

flextable::flextable(difference_raw_estimated_completeness)

```
Som vi ser over er det ikke store prosentdifferanser, altså utgjør det ikke stor
forskjell om man beregner rå forløpskompletthet eller estimert forløpskompletthet.
Dette er imidlertid når vi nå har sett på alle data i NorSpis så langt under ett.
Hvis man ser på komplettheten for en kortere tidsperiode, og som er nærmere dags 
dato, vil det være naturlig at differensen mellom rå og estimert 
forløpskompletthet vil øke. 

Vi kan illustrere dette ved å se på forløpskomplettheten så langt i år:

```{r}
completeness <- norspis2::make_table_DQ_completeness_endreg(dateFrom = "2021-01-01",
                                                            dateTo = "2021-12-09")
completeness_raw <- completeness[[1]]
completeness_estimated <- completeness[[2]] 
completeness_difference <- completeness[[3]]

flextable::flextable(completeness_raw)
flextable::flextable(completeness_estimated)
flextable::flextable(completeness_difference)


```


# Resultater

## Pasientrapporterte effekt- og utfallsmål

\pagebreak

### Skjemaet Pasienttilfredshet 

Under følger svar på de fire ja/nei-spørsmålene i skjemaet pasienttilfredshet, som pasientene spørres ved slutten av behandlingen. Det femte spørsmålet om vurdering av utfall av mottatt behandling er ikke med her, nå. 

```{r fig.width=9, fig.height=9, fig.align='center'}
variable <- c('PT03Utfallsvurd', 'PT01OnsketInvolv', 'PT02BleInvolv', 'PT04KontaktBrukerorg') #'PT05OrientertBrukerorg')
regType <- ''

for (valgtVar in variable) {
      outfile <- ''
      norspis2::NorSpis1FigAndeler(RegData=DL$RegData2, 
                        datoFra = "2019-01-01", 
                        valgtVar = valgtVar, 
                        datoTil = "2019-12-31",
                        reshID = params$reshID, 
                        enhetsUtvalg = 0, #0 nasjonal?
                        outfile = outfile, 
                        minald = 0, 
                        maxald = 150)
                        #minbmistart = "",
                        #maxbmistart = "", 
                        #regType = regType #filterargumenter bmi og regtype ikke lagt inn.
}
```

