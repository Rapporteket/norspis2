---
title: "Rapport - NorSpis"
author: 'Nasjonal oversikt'
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: 2
  html_document:
    df_print: paged
params: 
  reshID: 700821
  dateFrom: !r format(Sys.Date(), "%Y")
  dateTo: "`r Sys.Date()`" 
---

[//]: # Just a list of usefull rmarkdown formatting commands:
[//]: # \pagebreak


[//]: # just setting things up
```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo = params$reshID,
  message=FALSE,
  warning=FALSE,
  comment = "#>",
  cache.path = 'F:/'
)
```

```{r loadPackages, include=FALSE}
#rm(list=ls()) WARNING: Do not use this line in parameterized .Rmd-documents, or else the parameters will not be found 
library(rapbase)
library(tidyverse)
library(norspis2)
```

[//]: # remember to load data - use "script-to-load-data-locally-norspis (...)"

```{r}
library(dplyr)
#------DATA norspis2
RegData2 <- norspis2::fun1_1_import_data_FEA(path_data="F:/2021-09-13/", #disk and folder of data to import
                                             date_data="2021-09-13")

RegDataBeh2 <- norspis2::fun1_2_import_data_B(path_data="F:/2021-09-13/", #disk and folder of data to import
                                              date_data="2021-09-13")
#Five datasets (and outputted in a list):
DL <- norspis2::fun2_dataList(myInData1 = RegData2, myInData2 = RegDataBeh2)
#---DATA norspis2 (END)
#-----DATA  for norspis functions
#When we use norspis functions we use the call "RegData" (while we in norspis2 use DL$RegData12345)
RegData <- RegData2
#---DATA norspis2 (END)
```


[//]: # paramemters 

<!-- ```{r} -->
<!-- reshID = '700821' #TESTNO" , Oslo: 109979, Bodø: 700821 -->
<!-- userRole <-'SC' #'CC' , 'LC', 'LU' -->
<!-- ``` -->

\pagebreak

# Om denne rapporten

*Bruk:* Til bruk i fagrådsmøte uke 37 2021. Annen bruk må avklares med NorSpis-administrasjonen,
og dokumenteres der.

*Datagrunnlag:* Til og med uke 36, 2021 (12. september).


<!-- \pagebreak -->

<!-- # Antall pasienter -->

<!-- * Totalt -->
<!-- * Over tid -->
<!-- * Per enhet -->

\pagebreak

# Antall registreringer

* Totalt
* Over tid
* Per enhet


<!-- ## Antall registreringer per enhet -->
<!-- ```{r} -->
<!-- myInData <- DL$RegData2 -->
<!-- RegDataNatVal_filtered2019 <- norspis2::fun3_1_filter_RegData(RegData = myInData, -->
<!--                                                               regStatus = c(1), -->
<!--                                                               regType = c(1,2,3,4,5,6,98,99), -->
<!--                                                               dateFrom = "2020-01-01", -->
<!--                                                               dateTo = "2021-12-31", -->
<!--                                                               ageFrom = 0, -->
<!--                                                               ageTo = 200) -->

<!-- tab <- norspis2::make_table_DQ_regCount(RegDataNatVal_filtered2019) #%>% -->
<!--           #flextable::set_table_properties(layout = "autofit") -->
<!--           #flextable::fit_to_width(7.5) -->

<!-- #ft <- norspis2::make_table_DQ_regCount_asFt(tab) -->

<!-- tab[[2]] -->

<!-- #https://stackoverflow.com/questions/57175351/flextable-autofit-in-a-rmarkdown-to-word-doc-causes-table-to-go-outside-page-mar -->
<!-- # FitFlextableToPage <- function(ft, pgwidth = 5){ -->
<!-- #  -->
<!-- #   ft_out <- ft %>% flextable::autofit() -->
<!-- #  -->
<!-- #   ft_out <- flextable::width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable::flextable_dim(ft_out)$widths)) -->
<!-- #   return(ft_out) -->
<!-- # } -->
<!-- #  -->
<!-- # FitFlextableToPage(tab[[2]]) -->

<!-- ``` -->

\pagebreak

## Antall registreringer per avdeling per år

### Startregistreringer (ferdigstilte)

```{r, resize.width=5,resize.height=6}
  #START
  #filter data for e.g. 2012-2019
  RegDataNatValFiltered <- fun3_1_filter_RegData(RegData = DL$RegDataNatVal2 ,
                                                 regStatus = c(1),
                                                 regType = c(1,2,3,4),#START
                                                 dateFrom = "2012-01-01",
                                                 dateTo = "2021-12-31",
                                                 ageFrom = 0,
                                                 ageTo = 200)

  tab_start <- norspis2::make_table_DQ_regCountYearly(RegDataNatValFiltered = RegDataNatValFiltered,
                                                      width_first_column = 1.5)
  
  tab_start[[2]]
  

```


\pagebreak

### Sluttregistreringer (ferdigstilte)

```{r}
#END
  #filter data for e.g. 2012-2019
  RegDataNatValFiltered <- fun3_1_filter_RegData(RegData = DL$RegDataNatVal2 ,
                                                 regStatus = c(1),
                                                 regType = c(5,6,98,99),#END
                                                 dateFrom = "2012-01-01",
                                                 dateTo = "2021-12-31",
                                                 ageFrom = 0,
                                                 ageTo = 200)

  tab_slutt <- norspis2::make_table_DQ_regCountYearly(RegDataNatValFiltered = RegDataNatValFiltered)
  
  tab_slutt[[2]]
  
```
\pagebreak

### Startregistreringer (inkludert uferdige)

```{r, resize.width=5,resize.height=6}
  #START
  #filter data for e.g. 2012-2019
  RegDataNatValFiltered <- fun3_1_filter_RegData(RegData = DL$RegDataNatVal2 ,
                                                 regStatus = c(-1,0,1),
                                                 regType = c(1,2,3,4),#START
                                                 dateFrom = "2012-01-01",
                                                 dateTo = "2021-12-31",
                                                 ageFrom = 0,
                                                 ageTo = 200)

  tab_start <- norspis2::make_table_DQ_regCountYearly(RegDataNatValFiltered = RegDataNatValFiltered,
                                                      width_first_column = 1.5)
  
  tab_start[[2]]
  

```


\pagebreak

### Sluttregistreringer (inkludert uferdige)

```{r}
#END
  #filter data for e.g. 2012-2019
  RegDataNatValFiltered <- fun3_1_filter_RegData(RegData = DL$RegDataNatVal2 ,
                                                 regStatus = c(-1,0,1),
                                                 regType = c(5,6,98,99),#END
                                                 dateFrom = "2012-01-01",
                                                 dateTo = "2021-12-31",
                                                 ageFrom = 0,
                                                 ageTo = 200)

  tab_slutt <- norspis2::make_table_DQ_regCountYearly(RegDataNatValFiltered = RegDataNatValFiltered)
  
  tab_slutt[[2]]
  
```

\pagebreak



# Resultater

## Kvalitetsindikatorer over tid (så langt i år)

### Kvalitetsindikator 1: Andel pasienter med endring positiv endring i EDE-Q

```{r, message=FALSE}
KI1_time <- 
  norspis2::make_figFig_timetrend(
    my_data = DL$RegDataStartEndNatVal2,
    data_type = "start_end",
    variable01 =  "EDEQ60GlobalScore_CHANGE_PROP",
    variable_type_0_100 = FALSE,
    do_facet_wrap = T,
    show_legend = F)

KI1_time[[4]]
KI1_time[[3]]

```
\pagebreak

### Kvalitetsindikator 2: Andel pasienter med endring positiv endring i CIA 

```{r}
KI2_time <- 
  norspis2::make_figFig_timetrend(
    my_data = DL$RegDataStartEndNatVal2,
    data_type = "start_end",
    variable01 = "CIA30GlobalScore_RCI_01",
    variable_type_0_100 = FALSE,
    do_facet_wrap = T,
    show_legend = F)

KI2_time[[4]]
KI2_time[[3]]
```

\pagebreak
### Kvalitetsindikator 3: Andel pasienter som ikke lenger er undervektige ved behandlingsslutt

```{r}
KI3_time <- 
  norspis2::make_figFig_timetrend(
    my_data = DL$RegDataStartEndNatVal2,
    data_type = "start_end",
    variable01 = "MedBMI_start18.5_slutt18.5",
    variable_type_0_100 = FALSE,
    do_facet_wrap = T,
    show_legend = F)

KI3_time[[4]]
KI3_time[[3]]

```
\pagebreak

### Kvalitetsindikator 4: Pasientvurdert bedring("utfall") av behandlingen

Andelen pasiener som oppgir noen form for bedring ("ikke noe problem lenger",
"klar bedring" eller "noe bedring").

```{r}
KI5_time <- 
  norspis2::make_figFig_timetrend(
    my_data =  DL$RegDataNatVal2,
    data_type = "regular",
    variable01 = "PROP_PT03Utfallsvurd",
    variable_type_0_100 = FALSE,
    do_facet_wrap = T,
    show_legend = F)

KI5_time[[4]]
KI5_time[[3]]

```
\pagebreak

## Pasientrapporterte erfarings- og utfallsmål

### Pasientvurdert tilgjengelighet

Indeks 1 fra Pasienterfaringer - ett spørsmål alene: "Måtte du vente for å få
tilbud ved behandlinsenheten?". Skala fra 0 til 100, hvor høyere skåre angir
kortere opplevd ventetid.

```{r}
paserf_indeks1_tilgj_time <- norspis2::make_figFig_timetrend(
  my_data =  DL$RegDataNatVal2, 
  data_type = "regular",
  variable_type_0_100 = TRUE,
  variable01 = "PasOppTilgjengelighet",
  do_facet_wrap = T,
  show_legend = F)

paserf_indeks1_tilgj_time[[4]]
paserf_indeks1_tilgj_time[[3]]
```
\pagebreak

### Pasienttilfredshet

Indeks 2 fra Pasienterfaringer, om utbytte av behandlingen og om behandlingen 
var tilfredstillende. Skala fra 0 til 100. 

```{r}
paserf_indeks2_tilfreds_time <- norspis2::make_figFig_timetrend(
  my_data =  DL$RegDataNatVal2, 
  data_type = "regular",
  variable_type_0_100 = TRUE,
  variable01 = "PasOppTilfredshet",
  do_facet_wrap = T,
  show_legend = F)

paserf_indeks2_tilfreds_time[[4]]
paserf_indeks2_tilfreds_time[[3]]
```
\pagebreak

### Pasientvurderte erfaringer

Indeks 3 fra Pasienttilfredshet, om kommunikasjon, informasjon, hvorvidt
behandlingen var tilpasset pasientens situasjon, om pasienten var involvert i 
behandlingen, dyktighet hos behandlerne og om arbeidet ved avdelingen var godt 
organisert - slik pasienten ser det. Skala fra 0 til 100. 

```{r}
paserf_indeks3_erfaring_time <- norspis2::make_figFig_timetrend(
  my_data =  DL$RegDataNatVal2, 
  data_type = "regular",
  variable_type_0_100 = TRUE,
  variable01 = "PasOppErfaring",
  do_facet_wrap = T,
  show_legend = F)

paserf_indeks3_erfaring_time[[4]]
paserf_indeks3_erfaring_time[[3]]
```
\pagebreak

### Pasientvurdert pasientsikkerhet

Indeks 4 fra Pasienttilfredshet: "Mener du at du på noen måte ble feilbehandlet
(etter det du selv kan bedømme). Skala fra 0 til 100. 

```{r}
paserf_indeks4_psikkerhet_time <- norspis2::make_figFig_timetrend(
  my_data =  DL$RegDataNatVal2, 
  data_type = "regular",
  variable_type_0_100 = FALSE,
  variable01 = "PROP_PO10Pasientsikkerhet",
  do_facet_wrap = T,
  show_legend = F)

paserf_indeks4_psikkerhet_time[[4]]
paserf_indeks4_psikkerhet_time[[3]]
```

### Samlede svar fra skjemaet "pasienttilfredshet" utarbeidet av brukerorganisasjonene

```{r}
data_ordinary <- DL$RegData2 
data_ordinary_tom2021 <- norspis2::fun3_1_filter_RegData(RegData = data_ordinary,
                                        dateFrom =
                                          "2012-01-01",
                                        dateTo =
                                          "2021-12-31",
                                        regStatus = 1) #only complete reg

#filter RegDataNatVal
data_gjsn <- data_ordinary_tom2021 %>% 
                        #first make a variable that we will group results by:
                        mutate(Year_custom = case_when(Year == 2021 ~ "2021",
                                                       Year == 2020 ~ "2020",
                                                      Year < 2020 ~ "<=2019",
                                                      #Year == 2021 ~ "2021",
                                                      TRUE ~ NA_character_  )) %>%  
                        filter(
                             #Year %in% c(2019,2021),
                             BasisRegStatus == 1)  %>%
                        group_by(Year_custom) %>%
                        summarize(PT01=mean(as.numeric(PT01OnsketInvolv), na.rm=T),#mean
                                  PT02=mean(as.numeric(PT02BleInvolv), na.rm=T), #mean
                                  PT04=mean(as.numeric(PT04KontaktBrukerorg), na.rm=T), #mean
                                  PT05=mean(as.numeric(PT05OrientertBrukerorg), na.rm=T)) %>%#mean
                        tidyr::gather(PT02,PT01,PT05,PT04, key= "PT", value="gj_sn", na.rm = T)%>%
                        arrange(PT,Year_custom)%>%
                        mutate(my_key =c(1:length(.$Year_custom)))

data_counts <- data_ordinary_tom2021 %>%
                      #first make a variable that we will group results by:
                      mutate(Year_custom = case_when( Year == 2020 ~"2020",
                                                      Year == 2021 ~ "2021", 
                                                      Year < 2021 ~ "<=2019",
                                                      #Year == 2021 ~ "2021",
                                                      TRUE ~ NA_character_  )) %>% 
                      filter(
                             #Year %in% c(2019,2021),
                             BasisRegStatus == 1)  %>%
                          group_by(Year_custom) %>%
                          summarize(PT01 = sum(PT01OnsketInvolv %in% c(0,1)),#counts valid observations 
                                    PT02 = sum(PT02BleInvolv %in% c(0,1)),
                                    PT04 = sum(PT04KontaktBrukerorg %in% c(0,1)),
                                    PT05 = sum(PT05OrientertBrukerorg %in% c(0,1))) %>%
                      tidyr::gather(PT01,PT02,PT04,PT05, key="PT", value="n")%>%
                      arrange(PT,Year_custom)%>%
                      mutate(my_key =c(1:length(.$Year_custom)))


data <- data_gjsn %>% #merge counts and percentages into one table, and rename values of PT
            full_join(data_counts)%>%
            mutate(PT = case_when(
                              PT == "PT01" ~ "Familie/venner \n var ønsket involvert",
                              PT == "PT02" ~ "Familie/venner \n ble involvert",
                              PT == "PT04" ~ "Noen gang \n kontakt med \n ROS/SPISFO",
                              PT == "PT05" ~ "Fikk informasjon \n ila. behandling \n om ROS/SPISFO"))

p <- ggplot(data, aes(x= PT,y=gj_sn*100, fill=as.factor(Year_custom)))+
  geom_col(position = "dodge")+
  geom_text(#to map percentace label at bar
      aes(x = PT, y= gj_sn*100, # ta map on TOP of bar - use 
          label=scales::percent(gj_sn, 
                                decimal.mark = ",",
                                accuracy = 0.1)), 
      alpha=0.5,
      size=2,
      position = position_dodge(0.9), #to place percentage text at each bar (not each bar pair)
      vjust=1.5)+
  geom_text(#to map n label at bar
      aes(x = PT, y= 0, # ta map on TOP of bar - use 
          label=paste0("N=",n, "")), 
      alpha=0.5,
      size = 2,
      position = position_dodge(0.9), #to place percentage text at each bar (not each bar pair)
      vjust=-0.5)+
  ggplot2::labs(title = 'Samlende svar fra skjemaet "pasienttilfredshet" utarbeidet av brukerorganisasjonene'  #labels: title, subtitle and caption
                # subtitle = paste0("(N = ",
                #                   sum(
                #                     #as.numeric(
                #                       case_when(
                #                         data$Year_custom == "<=2019" ~ data$n), 
                #                     na.rm = T),
                #                   ") ",
                #                   "N = ",
                #                   sum(
                #                     #as.numeric(
                #                       case_when(
                #                         data$Year_custom == "2021" ~ data$n),
                #                     na.rm = T),
                #                   "")
                )+
  
  xlab("")+
  ylab("Andel (%)")+
  theme_minimal()+
  theme(panel.grid.major.x = element_blank(),
                  panel.grid.minor.x = element_blank())+
  scale_y_continuous(breaks = seq(10,100,10))+
  scale_fill_discrete(name="År")+
  scale_fill_manual(values = c("grey",
                               "lightgrey",
                               "lightblue"
                               ) , name = 'År')
p

```

<!-- ### Skjemaet Pasienttilfredshet  -->

<!-- Under følger svar på de fire ja/nei-spørsmålene i skjemaet pasienttilfredshet, som pasientene spørres ved slutten av behandlingen. Det femte spørsmålet om vurdering av utfall av mottatt behandling er ikke med her, nå.  -->

<!-- ```{r fig.width=9, fig.height=9, fig.align='center'} -->
<!-- variable <- c('PT03Utfallsvurd', 'PT01OnsketInvolv', 'PT02BleInvolv', 'PT04KontaktBrukerorg') #'PT05OrientertBrukerorg') -->
<!-- regType <- '' -->

<!-- for (valgtVar in variable) { -->
<!--       outfile <- '' -->
<!--       norspis2::NorSpis1FigAndeler(RegData=DL$RegData2,  -->
<!--                         datoFra = "2019-01-01",  -->
<!--                         valgtVar = valgtVar,  -->
<!--                         datoTil = "2019-12-31", -->
<!--                         reshID = params$reshID,  -->
<!--                         enhetsUtvalg = 0, #0 nasjonal? -->
<!--                         outfile = outfile,  -->
<!--                         minald = 0,  -->
<!--                         maxald = 150) -->
<!--                         #minbmistart = "", -->
<!--                         #maxbmistart = "",  -->
<!--                         #regType = regType #filterargumenter bmi og regtype ikke lagt inn. -->
<!-- } -->
<!-- ``` -->

